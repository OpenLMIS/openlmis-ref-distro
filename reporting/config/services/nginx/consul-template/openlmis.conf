{{ $loaded_services := services }}
{{ $resources := tree (env "RESOURCES_PATH") }}

{{ range $loaded_services }}
{{- if in .Tags (env "SERVICE_TAG") -}}
{{- $current_service := service .Name "any" -}}
{{- if not (eq (len $current_service) 0) }}
upstream {{ .Name }} {
  least_conn;
  keepalive 128;
  {{ range $current_service }}server {{ .Address }}:{{ .Port }};
{{ end }}
}
{{ end -}}
{{- end -}}
{{ end }}

log_format upstream_time '$remote_addr - $remote_user [$time_local] '
                 '"$request" $status $body_bytes_sent '
                 '"$http_referer" "$http_user_agent" '
                 '$request_time $upstream_connect_time '
                 '$upstream_header_time $upstream_response_time '
                 '$pipe';

{{ range $resources }} {{ $location := .Key }} {{ $upstream := .Value }}
server {
  server_name {{ $location }};
  listen 80;

  location / {
    proxy_pass http://{{ $upstream }};
  }
}

{{ end }}
